GetPriceApprovalRequests:
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[GetPriceApprovalRequests]
    @RequestID NVARCHAR(50),
    @Status INT,
    @Id NVARCHAR(50),
    @Role NVARCHAR(50)    
AS
BEGIN
    SELECT 
        par.request_name,
        c.name AS customer_name, 
        par.customer_id AS customer_ids,
        consignee.name AS consignee_name, 
        par.consignee_id AS consignee_ids,
        enduse.name AS enduse_name,
        par.end_use_id,
        par.plant,
        CONVERT(VARCHAR, CAST(par.valid_from AS DATETIME), 103) AS valid_from,
        CONVERT(VARCHAR, CAST(par.valid_to AS DATETIME), 103) AS valid_to,
        par.payment_terms_id
    FROM price_approval_requests par
    LEFT JOIN customer c ON par.customer_id = c.id
    LEFT JOIN customer consignee ON par.consignee_id = consignee.id
    LEFT JOIN customer enduse ON par.end_use_id = enduse.id
    JOIN requests_mvc rs ON par.request_name = rs.req_id
    JOIN transaction_mvc tmvc on par.request_name =  tmvc.request_id
    INNER JOIN price_approval_requests_price_table parpt ON par.request_name = parpt.req_id
    INNER JOIN profit_center PC ON parpt.grade = PC.Grade
    INNER JOIN business_admin_variables BAV ON BAV.value = LEFT(CAST(ABS(PC.Profit_Centre) AS VARCHAR(10)), 1)
    JOIN define_roles dr on tmvc.last_updated_by_id = dr.employee_id
    WHERE par.request_name = @RequestID
      AND BAV.[key] = @Role
      AND dr.region IN (SELECT region FROM [PriceApprovalSystem].[dbo].[define_roles] WHERE employee_id = @Id)
      AND rs.status = @Status
      AND (par.customer_id <> '' OR par.consignee_id <> '' OR par.end_use_id <> '');
END;
GO


GetPriceApprovalRequestsHigh:
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[GetPriceApprovalRequestsHigh]
    @RequestID NVARCHAR(50),
    @Status INT,
    @Role NVARCHAR(50)
    -- @Id INT
AS
BEGIN
    SELECT 
        par.request_name,
        c.name AS customer_name, 
        par.customer_id AS customer_ids,
        consignee.name AS consignee_name, 
        par.consignee_id AS consignee_ids,
        enduse.name AS enduse_name,
        par.end_use_id,
        par.plant,
        CONVERT(VARCHAR, CAST(par.valid_from AS DATETIME), 103) AS valid_from,
        CONVERT(VARCHAR, CAST(par.valid_to AS DATETIME), 103) AS valid_to,
        par.payment_terms_id
    FROM price_approval_requests par
    LEFT JOIN customer c ON par.customer_id = c.id
    LEFT JOIN customer consignee ON par.consignee_id = consignee.id
    LEFT JOIN customer enduse ON par.end_use_id = enduse.id
    JOIN requests_mvc rs ON par.request_name = rs.req_id
    JOIN transaction_mvc tmvc on par.request_name =  tmvc.request_id
    INNER JOIN price_approval_requests_price_table parpt ON par.request_name = parpt.req_id
    INNER JOIN profit_center PC ON parpt.grade = PC.Grade
    INNER JOIN business_admin_variables BAV ON BAV.value = LEFT(CAST(ABS(PC.Profit_Centre) AS VARCHAR(10)), 1)
    JOIN define_roles dr on tmvc.last_updated_by_id = dr.employee_id
    WHERE par.request_name = @RequestID
      AND BAV.[key] = @Role  
--    AND dr.region IN (SELECT region FROM [PriceApprovalSystem].[dbo].[define_roles] WHERE employee_id = @Id)
      AND rs.status = @Status
      AND (par.customer_id <> '' OR par.consignee_id <> '' OR par.end_use_id <> '');
END;
GO
